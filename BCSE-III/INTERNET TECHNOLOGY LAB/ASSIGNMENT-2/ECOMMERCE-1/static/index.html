<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ECommerce</title>
  <!-- Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
  />
  <!-- Font Awesome for cart icon -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />
  <style>
    /* Additional styling for product cards */
    .product-card {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">ECommerce</a>
    <!-- Added Welcome message element in the center -->
    <div id="welcomeMessage" class="mx-auto" style="display:none; color: white;">
      Welcome, <span id="welcomeUser"></span>
    </div>
    <div class="ml-auto d-flex align-items-center">
      <!-- **Added Past Orders button to the left of Cart** -->
      <button id="pastOrdersButton" class="btn btn-outline-light mr-2">
        Past Orders
      </button>
      <button id="cartButton" class="btn btn-outline-light">
        <i class="fas fa-shopping-cart"></i> Cart (<span id="cartCount">0</span>)
      </button>
      <!-- Logout Button (hidden until login) -->
      <button id="logoutButton" class="btn btn-outline-light ml-2" style="display:none;">
        Logout
      </button>
    </div>
  </nav>

  <div class="container my-4">
    <!-- Authentication Section (Login/Register) -->
    <div id="authSection">
      <ul class="nav nav-tabs" id="authTab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="login-tab" data-toggle="tab" href="#login" role="tab" aria-controls="login" aria-selected="true">Login</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="register-tab" data-toggle="tab" href="#register" role="tab" aria-controls="register" aria-selected="false">Register</a>
        </li>
      </ul>
      <div class="tab-content" id="authTabContent">
        <div class="tab-pane fade show active p-3" id="login" role="tabpanel" aria-labelledby="login-tab">
          <form id="loginForm">
            <div class="form-group">
              <label for="loginUsername">Username</label>
              <input type="text" id="loginUsername" class="form-control" placeholder="Enter username" required />
            </div>
            <div class="form-group">
              <label for="loginPassword">Password</label>
              <input type="password" id="loginPassword" class="form-control" placeholder="Enter password" required />
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
          </form>
          <pre id="loginResult" class="mt-2"></pre>
        </div>
        <div class="tab-pane fade p-3" id="register" role="tabpanel" aria-labelledby="register-tab">
          <form id="registerForm">
            <div class="form-group">
              <label for="registerUsername">Username</label>
              <input type="text" id="registerUsername" class="form-control" placeholder="Enter username" required />
            </div>
            <div class="form-group">
              <label for="registerPassword">Password</label>
              <input type="password" id="registerPassword" class="form-control" placeholder="Enter password" required />
            </div>
            <button type="submit" class="btn btn-primary">Register</button>
          </form>
          <pre id="registerResult" class="mt-2"></pre>
        </div>
      </div>
    </div>

    <!-- Product Listing Section (hidden until login) -->
    <div id="productSection" style="display:none;">
      <!-- Admin Panel: Only visible to admin -->
      <div id="adminSection" style="display:none;" class="mb-4">
        <h3>Admin Panel: Add New Product</h3>
        <form id="adminProductForm">
          <div class="form-group">
            <label for="newProductName">Product Name</label>
            <input type="text" id="newProductName" class="form-control" placeholder="Enter product name" required />
          </div>
          <div class="form-group">
            <label for="newProductDescription">Product Description</label>
            <textarea id="newProductDescription" class="form-control" placeholder="Enter product description" required></textarea>
          </div>
          <div class="form-group">
            <label for="newProductStock">Stock</label>
            <input type="number" id="newProductStock" class="form-control" placeholder="Enter stock" required />
          </div>
          <div class="form-group">
            <label for="newProductPrice">Price</label>
            <input type="number" step="0.01" id="newProductPrice" class="form-control" placeholder="Enter price" required />
          </div>
          <button type="submit" class="btn btn-success">Add Product</button>
        </form>
        <pre id="adminProductResult" class="mt-2"></pre>
      </div>
      <div id="productList" class="row">
        <!-- Product cards will be inserted here dynamically -->
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div
    class="modal fade"
    id="cartModal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="cartModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cartModalLabel">Your Cart</h5>
          <button
            type="button"
            class="close"
            data-dismiss="modal"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="cartItems">
            <!-- Cart items will be dynamically listed here -->
          </div>
        </div>
        <div class="modal-footer">
          <button id="checkoutButton" type="button" class="btn btn-success">
            Checkout
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            data-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- **Added Past Orders Modal** -->
  <div
    class="modal fade"
    id="ordersModal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="ordersModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ordersModalLabel">Past Orders</h5>
          <button
            type="button"
            class="close"
            data-dismiss="modal"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="ordersList">
            <!-- Past orders will be inserted here -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts: jQuery, Popper.js, Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    // Adjust the API base URL as needed.
    const API_BASE_URL = "http://127.0.0.1:8000";
    let loggedInUser = null;
    let products = [];
    let cart = [];

    // Helper function for displaying JSON results
    function displayResult(elementId, data) {
      document.getElementById(elementId).innerText = JSON.stringify(data, null, 2);
    }

    // --------------------
    // Authentication Logic
    // --------------------

    // Registration form handler
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("registerUsername").value;
      const password = document.getElementById("registerPassword").value;
      const payload = { username, password };
      try {
        const res = await fetch(`${API_BASE_URL}/users/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        displayResult("registerResult", data);
        if (data.id) {
          // Registration successful; automatically log in
          loggedInUser = data;
          enterShop();
        }
      } catch (error) {
        displayResult("registerResult", { error: error.toString() });
      }
    });

    // Login form handler
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("loginUsername").value;
      const password = document.getElementById("loginPassword").value;
      const payload = { username, password };
      try {
        const res = await fetch(`${API_BASE_URL}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        displayResult("loginResult", data);
        if (data.id) {
          loggedInUser = data;
          enterShop();
        }
      } catch (error) {
        displayResult("loginResult", { error: error.toString() });
      }
    });

    // Once logged in, hide the auth section and show the product listing
    async function enterShop() {
      document.getElementById("authSection").style.display = "none";
      document.getElementById("productSection").style.display = "block";
      // Show logout button when logged in
      document.getElementById("logoutButton").style.display = "inline-block";
      if (loggedInUser.username === "admin") {
        document.getElementById("adminSection").style.display = "block";
      }
      await fetchProducts();
    }

    // --------------------
    // Products and Cart
    // --------------------

    // Fetch products from API (expects GET /products/ to return an array)
    async function fetchProducts() {
      try {
        const res = await fetch(`${API_BASE_URL}/products/`);
        products = await res.json();
        renderProducts();
      } catch (error) {
        console.error("Error fetching products:", error);
      }
    }

    // Render product cards into the product list
    function renderProducts() {
      const productList = document.getElementById("productList");
      productList.innerHTML = "";
      products.forEach((product) => {
        // Skip rendering if stock is 0
        if (product.stock <= 0) return;
        const col = document.createElement("div");
        col.className = "col-md-4";
        const card = document.createElement("div");
        card.className = "card product-card";
        card.innerHTML = `
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title">Rs {product.name}</h5>
              <p class="text-muted" style="font-size: 0.9rem;">Price: Rs ${product.price.toFixed(2)}</p>
              <p class="text-muted" style="font-size: 0.9rem;">Stock: <span id="stock-${product.id}">${product.stock}</span></p>
            </div>
            <div>
              <button class="btn ${isInCart(product.id) ? "btn-danger" : "btn-primary"}" data-product-id="${product.id}">
                ${isInCart(product.id) ? "Remove from Cart" : "Add to Cart"}
              </button>
            </div>
          </div>
        `;
        // Attach event listener for add/remove functionality
        card
          .querySelector("button")
          .addEventListener("click", function () {
            const prodId = product.id;
            if (isInCart(prodId)) {
              removeFromCart(prodId);
              this.className = "btn btn-primary";
              this.innerText = "Add to Cart";
            } else {
              addToCart(product);
              this.className = "btn btn-danger";
              this.innerText = "Remove from Cart";
            }
            updateCartCount();
            renderCartModal(); // update modal if it's open
          });
        col.appendChild(card);
        productList.appendChild(col);
      });
    }

    // Check if a product is already in the cart
    function isInCart(productId) {
      return cart.some((item) => item.id === productId);
    }

    // Add a product to the cart
    function addToCart(product) {
      if (!isInCart(product.id)) {
        cart.push(product);
      }
    }

    // Remove a product from the cart
    function removeFromCart(productId) {
      cart = cart.filter((item) => item.id !== productId);
      renderProducts(); // refresh product list buttons
    }

    // Update the cart count displayed in the nav bar
    function updateCartCount() {
      document.getElementById("cartCount").innerText = cart.length;
    }

    // Render the contents of the cart modal
    function renderCartModal() {
      const cartItemsDiv = document.getElementById("cartItems");
      cartItemsDiv.innerHTML = "";
      if (cart.length === 0) {
        cartItemsDiv.innerHTML = "<p>Your cart is empty.</p>";
        return;
      }

      let totalPrice = 0;
      cart.forEach((product) => {
        totalPrice += product.price; // Accumulate total price
        const itemDiv = document.createElement("div");
        itemDiv.className =
          "d-flex justify-content-between align-items-center border p-2 mb-2";
        itemDiv.innerHTML = `
          <span>${product.name} - Rs ${product.price.toFixed(2)}</span>
          <button class="btn btn-sm btn-danger" data-product-id="${product.id}">
            Remove from Cart
          </button>
        `;
        itemDiv
          .querySelector("button")
          .addEventListener("click", function () {
            removeFromCart(product.id);
            updateCartCount();
            renderProducts();
            renderCartModal();
          });
        cartItemsDiv.appendChild(itemDiv);
      });

      const totalPriceDiv = document.createElement("div");
      totalPriceDiv.className = "mt-3 font-weight-bold";
      totalPriceDiv.innerHTML = `Total Price: Rs ${totalPrice.toFixed(2)}`;
      cartItemsDiv.appendChild(totalPriceDiv);
    }

    // Show the cart modal when the cart button is clicked
    document
      .getElementById("cartButton")
      .addEventListener("click", function () {
        renderCartModal();
        $("#cartModal").modal("show");
      });

    // Checkout button event â€“ creates a new order via the /orders/ endpoint.
    document
      .getElementById("checkoutButton")
      .addEventListener("click", async function () {
        if (cart.length === 0) {
          alert("Your cart is empty.");
          return;
        }
        // Prepare payload (adjust according to your backend's expected format).
        // Here we assume the order endpoint can accept multiple product IDs.
        const product_ids = cart.map((item) => item.id);
        const payload = { user_id: loggedInUser.id, product_ids: product_ids };
        try {
          const res = await fetch(`${API_BASE_URL}/orders/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          alert("Order created successfully!");

          // Decrement stock locally
          cart.forEach((product) => {
            const productInList = products.find((p) => p.id === product.id);
            if (productInList) {
              productInList.stock--; // Reduce stock count
              document.getElementById(`stock-${product.id}`).innerText = productInList.stock;
            }
          });

          // Clear the cart and update UI.
          cart = [];
          updateCartCount();
          renderProducts();
          $("#cartModal").modal("hide");
        } catch (error) {
          alert("Error during checkout: " + error.toString());
        }
      });

      // --------------------
      // Past Orders: Fetch and display past orders
      // --------------------
      document.getElementById("pastOrdersButton").addEventListener("click", async function () {
        if (!loggedInUser || !loggedInUser.id) {
          alert("Please log in first.");
          return;
        }
        try {
          const res = await fetch(`${API_BASE_URL}/orders/${loggedInUser.id}`);
          if (!res.ok) {
            const errorText = await res.text();
            throw new Error(errorText);
          }
          const ordersData = await res.json();
          renderOrdersModal(ordersData);
          $("#ordersModal").modal("show");
        } catch (error) {
          alert("Error fetching past orders: " + error.toString());
        }
      });

      // Render the contents of the Past Orders modal.
      function renderOrdersModal(orders) {
        const ordersListDiv = document.getElementById("ordersList");
        ordersListDiv.innerHTML = "";
        if (!orders || orders.length === 0) {
          ordersListDiv.innerHTML = "<p>No past orders found.</p>";
          return;
        }
        orders.forEach((order) => {
          // Customize this display as needed based on your order structure.
          const orderDiv = document.createElement("div");
          orderDiv.className = "border p-2 mb-2";
          orderDiv.innerHTML = `
            <strong>Order ID:</strong> ${order.id}<br>
            <strong>Products:</strong> ${order.product_ids ? order.product_ids.join(", ") : "N/A"}
          `;
          ordersListDiv.appendChild(orderDiv);
        });
      }

      // --------------------
    // Logout: Clear user session and return to Login/Register page.
    // --------------------
    document.getElementById("logoutButton").addEventListener("click", function () {
      loggedInUser = null;
      cart = [];
      updateCartCount();
      // Hide product section and show auth section
      document.getElementById("productSection").style.display = "none";
      document.getElementById("adminSection").style.display = "none";
      document.getElementById("authSection").style.display = "block";
      // Hide logout button
      document.getElementById("logoutButton").style.display = "none";
    });

    // --------------------
    // Admin: Add New Product
    // --------------------
    // This form is only visible if the logged in user is admin.
    document.getElementById("adminProductForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("newProductName").value;
      const description = document.getElementById("newProductDescription").value;
      const stock = parseInt(document.getElementById("newProductStock").value, 10);
      const price = parseFloat(document.getElementById("newProductPrice").value);
      const payload = { name, description, stock, price }; // send all fields together
      try {
        const res = await fetch(`${API_BASE_URL}/products/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(errorText);
        }
        const data = await res.json();
        document.getElementById("adminProductResult").innerText = JSON.stringify(data, null, 2);
        await fetchProducts();
        document.getElementById("newProductName").value = "";
        document.getElementById("newProductDescription").value = "";
        document.getElementById("newProductStock").value = "";
        document.getElementById("newProductPrice").value = "";
      } catch (error) {
        document.getElementById("adminProductResult").innerText = error.toString();
      }
    });
  </script>
</body>
</html>
